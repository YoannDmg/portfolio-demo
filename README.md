# Crypto Portfolio Demo

A real-time cryptocurrency portfolio management application with AI-powered price alerts.

Built with **Convex**, **React**, **TypeScript**, **shadcn/ui**, and integrated with **Binance API** for live market data and **OpenRouter** for AI-generated market analysis.

---

## Table of Contents

- [Features](#features)
- [Architecture](#architecture)
- [Tech Stack](#tech-stack)
- [Project Structure](#project-structure)
- [Design Decisions](#design-decisions)
- [Data Model](#data-model)
- [Getting Started](#getting-started)
- [Environment Variables](#environment-variables)
- [Available Scripts](#available-scripts)

---

## Features

### Portfolio Management
- **Wallet System**: Deposit and withdraw USDT (base currency)
- **Trading**: Buy and sell cryptocurrencies at real-time market prices
- **Holdings Overview**: View all positions with P&L calculations
- **Transaction History**: Complete audit trail of all operations

### Real-Time Data
- **Live Prices**: 30-second auto-refresh from Binance public API
- **24h Change**: Price variation indicators for each asset
- **Portfolio Valuation**: Real-time total portfolio value calculation

### AI-Powered Alerts
- **Price Monitoring**: Automated cron job checking prices every minute
- **Alert Threshold**: Triggers when 24h price change exceeds 5%
- **AI Analysis**: Each alert includes market commentary generated by Mistral AI via OpenRouter
- **Notification Panel**: Dashboard card displaying all alerts with read/unread status

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         FRONTEND                                │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌─────────────┐  │
│  │  App.tsx  │  │   Hooks   │  │Components │  │    Types    │  │
│  │  (Root)   │  │ usePrices │  │  Header   │  │   Asset     │  │
│  │           │  │ useTrading│  │  Cards    │  │Transaction  │  │
│  │           │  │ useStats  │  │  Tables   │  │Notification │  │
│  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘  └─────────────┘  │
│        │              │              │                          │
│        └──────────────┼──────────────┘                          │
│                       │                                         │
│              useQuery / useMutation / useAction                 │
│                       │                                         │
└───────────────────────┼─────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│                      CONVEX BACKEND                             │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                      Functions                            │  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────────┐  │  │
│  │  │ wallet  │ │ assets  │ │ trading │ │  transactions   │  │  │
│  │  │ deposit │ │  list   │ │   buy   │ │   listRecent    │  │  │
│  │  │withdraw │ │  get    │ │  sell   │ │                 │  │  │
│  │  │getBalance│ │        │ │         │ │                 │  │  │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────────────┘  │  │
│  │  ┌─────────────────────┐ ┌─────────────────────────────┐  │  │
│  │  │       alerts        │ │       notifications         │  │  │
│  │  │  checkPriceAlerts   │ │   list / markAsRead         │  │  │
│  │  │   triggerCheck      │ │      markAllAsRead          │  │  │
│  │  │ generateAIAnalysis  │ │                             │  │  │
│  │  └─────────────────────┘ └─────────────────────────────┘  │  │
│  │  ┌─────────────────────┐                                  │  │
│  │  │        crons        │  ← Runs every minute             │  │
│  │  │  check-price-alerts │                                  │  │
│  │  └─────────────────────┘                                  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                  │
│                              ▼                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                      Database                             │  │
│  │   wallet │ assets │ transactions │ notifications          │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                        │
          ┌─────────────┼─────────────┐
          │             │             │
          ▼             ▼             ▼
    ┌──────────┐  ┌──────────┐  ┌──────────┐
    │ Binance  │  │OpenRouter│  │  Convex  │
    │   API    │  │   API    │  │  Cloud   │
    │ (Prices) │  │   (AI)   │  │(Realtime)│
    └──────────┘  └──────────┘  └──────────┘
```

---

## Tech Stack

| Layer | Technology | Purpose |
|-------|------------|---------|
| **Frontend** | React 19 | UI framework |
| **Language** | TypeScript | Type safety |
| **Styling** | Tailwind CSS 4 | Utility-first CSS |
| **Components** | shadcn/ui | Accessible UI primitives |
| **Backend** | Convex | Real-time database & serverless functions |
| **Build** | Vite | Fast development & bundling |
| **Market Data** | Binance Public API | Real-time cryptocurrency prices |
| **AI** | OpenRouter (Mistral 7B) | Market analysis generation |

---

## Project Structure

```
demo/
├── convex/                     # Backend (Convex)
│   ├── schema.ts               # Database schema definition
│   ├── wallet.ts               # Wallet operations (deposit/withdraw)
│   ├── assets.ts               # Portfolio asset queries
│   ├── trading.ts              # Buy/sell logic with price fetching
│   ├── transactions.ts         # Transaction history
│   ├── binance.ts              # Binance API integration
│   ├── alerts.ts               # Price alert system + AI analysis
│   ├── crons.ts                # Scheduled jobs configuration
│   └── notifications.ts        # Alert notification management
│
├── src/
│   ├── main.tsx                # React entry point with ConvexProvider
│   ├── App.tsx                 # Root component, layout orchestration
│   │
│   ├── components/             # UI Components
│   │   ├── index.ts            # Barrel export
│   │   ├── Header.tsx          # App header with notifications popover
│   │   ├── SummaryCards.tsx    # Portfolio KPIs (value, P&L, assets)
│   │   ├── WalletCard.tsx      # Deposit/withdraw form
│   │   ├── TradingCard.tsx     # Buy/sell form
│   │   ├── HoldingsTable.tsx   # Portfolio positions table
│   │   ├── TransactionHistory.tsx  # Transaction log
│   │   ├── NotificationsCard.tsx   # AI alerts dashboard card
│   │   ├── NotificationsPanel.tsx  # Header popover notifications
│   │   ├── ErrorAlert.tsx      # Error display component
│   │   └── ui/                 # shadcn/ui primitives
│   │       ├── button.tsx
│   │       ├── card.tsx
│   │       ├── input.tsx
│   │       ├── badge.tsx
│   │       ├── table.tsx
│   │       └── popover.tsx
│   │
│   ├── hooks/                  # Custom React hooks
│   │   ├── index.ts            # Barrel export
│   │   ├── usePrices.ts        # Real-time price fetching (30s interval)
│   │   ├── useTrading.ts       # Trading operations with error handling
│   │   └── usePortfolioStats.ts # Memoized portfolio calculations
│   │
│   ├── types/                  # TypeScript definitions
│   │   └── index.ts            # Asset, Transaction, Notification, PriceData
│   │
│   └── lib/
│       └── utils.ts            # Utility functions (cn for classnames)
│
├── package.json
├── tsconfig.json               # TypeScript configuration
├── tsconfig.app.json           # App-specific TS config
├── vite.config.ts              # Vite configuration
└── eslint.config.js            # ESLint configuration
```

---

## Design Decisions

### 1. Convex as Backend

**Why Convex over traditional REST/GraphQL?**

- **Real-time by default**: All queries automatically subscribe to updates. When data changes, the UI updates instantly without polling or WebSocket configuration.
- **Type safety end-to-end**: TypeScript types are generated from the schema, ensuring frontend-backend type consistency.
- **Serverless functions**: No server management, automatic scaling.
- **Transactional mutations**: Database operations are ACID-compliant.

**Trade-off**: Vendor lock-in, but acceptable for a demo/prototype.

### 2. Component Architecture

**Separation of Concerns:**

```
App.tsx (Orchestration)
    │
    ├── Data fetching (useQuery)
    ├── Hook composition (usePrices, useTrading, usePortfolioStats)
    │
    └── Pure UI components (receive props, render UI)
```

- **App.tsx**: Single source of truth for data fetching
- **Components**: Stateless where possible, focused on presentation
- **Hooks**: Encapsulate complex logic (price fetching, trading operations)

**Why this pattern?**
- Testability: Components can be tested with mock props
- Reusability: Components don't depend on specific data sources
- Maintainability: Clear boundaries between data and presentation

### 3. Price Data Strategy

**Binance Integration:**

```typescript
// Frontend: usePrices hook
- Fetches prices every 30 seconds
- Uses Binance public API (no auth required)
- Caches by symbol to avoid redundant calls

// Backend: alerts.ts
- Fetches 24h ticker data for threshold checks
- Runs via cron job every minute
```

**Why dual fetching?**
- Frontend needs frequent updates for responsive UI
- Backend needs independent checking for alerts (runs even if no user is connected)

### 4. Alert System Architecture

**Flow:**

```
Cron Job (every minute)
    │
    ▼
checkPriceAlerts (internalAction)
    │
    ├── Fetch assets from DB
    ├── Fetch 24h prices from Binance
    ├── Filter: |priceChange| > 5%
    │
    ▼
For each triggered asset:
    ├── Generate AI analysis (OpenRouter)
    └── Create notification in DB
```

**Why internalAction?**

- Actions can make HTTP requests (queries/mutations cannot)
- `internal` prefix prevents direct client calls (security)
- Cron jobs can only call internal functions

### 5. AI Integration

**OpenRouter Choice:**

- **Free tier available**: Mistral 7B Instruct is free
- **OpenAI-compatible API**: Easy integration, standard format
- **No vendor lock-in**: Can switch models easily

**Prompt Engineering:**

```typescript
const prompt = `
You are a crypto market analyst.
Provide a concise market insight (3–4 sentences)...
Do NOT provide financial advice.
`
```

- Structured output request (3-4 sentences)
- Professional tone directive
- Disclaimer requirement (no financial advice)

### 6. Type System

**Centralized Types:**

```typescript
// src/types/index.ts
export type Asset = Doc<'assets'>        // From Convex schema
export type Transaction = Doc<'transactions'>
export type Notification = Doc<'notifications'>
export type PriceData = { symbol, price, priceChangePercent }
export type PortfolioStats = { totalValue, totalCost, totalPnL, ... }
```

**Benefits:**
- Single source of truth
- Convex types are auto-generated from schema
- Frontend types extend backend types

### 7. Error Handling Strategy

**Levels:**

1. **Hook level** (`useTrading`): Catches errors, sets error state
2. **Component level** (`ErrorAlert`): Displays errors to user
3. **Backend level**: Convex handles retries for transient failures

**Graceful Degradation:**
- AI analysis falls back to simple message if API fails
- Price display falls back to avgBuyPrice if Binance unavailable

---

## Data Model

### Schema (Convex)

```typescript
// wallet - Single row for USDT balance
{
  balance: number  // Current USDT balance
}

// assets - Portfolio holdings
{
  symbol: string      // e.g., "BTC", "ETH"
  quantity: number    // Amount owned
  avgBuyPrice: number // Weighted average purchase price
}

// transactions - Audit log
{
  type: "deposit" | "withdraw" | "buy" | "sell"
  symbol?: string     // Only for buy/sell
  quantity: number    // Amount
  price?: number      // Unit price for trades
  total: number       // Total USDT value
  timestamp: number   // Unix timestamp
}

// notifications - AI alerts
{
  symbol: string
  type: "price_up" | "price_down"
  priceChange: number   // Percentage change
  currentPrice: number  // Price at alert time
  aiAnalysis: string    // AI-generated commentary
  timestamp: number
  read: boolean
}
```

---

## Getting Started

### Prerequisites

- Node.js 20.x or higher
- npm or yarn
- A Convex account (free tier available)
- An OpenRouter API key (free tier available)

### Installation

```bash
# Clone the repository
git clone https://github.com/YoannDmg/portfolio-demo.git
cd portfolio-demo

# Install dependencies
npm install

# Initialize Convex (first time only)
npx convex dev
# This will prompt you to log in and create a project
```

### Configuration

1. **Set up Convex environment variables:**

   Go to your [Convex Dashboard](https://dashboard.convex.dev) → Settings → Environment Variables

   Add:
   ```
   OPENROUTER_API_KEY=sk-or-v1-your-api-key-here
   ```

2. **Get an OpenRouter API key:**

   - Go to [OpenRouter](https://openrouter.ai)
   - Create an account
   - Generate an API key (free tier includes Mistral 7B)

### Running the Application

```bash
# Terminal 1: Start Convex backend
npx convex dev

# Terminal 2: Start frontend
npm run dev
```

Open [http://localhost:5173](http://localhost:5173) in your browser.

### First Steps

1. **Deposit USDT**: Use the Wallet card to add funds (e.g., 10000 USDT)
2. **Buy crypto**: Enter a symbol (BTC, ETH, SOL...) and amount
3. **Watch prices**: Holdings table updates every 30 seconds
4. **Check alerts**: Click "Check Now" in the notifications card to trigger alert check manually

---

## Environment Variables

| Variable | Location | Description |
|----------|----------|-------------|
| `OPENROUTER_API_KEY` | Convex Dashboard | API key for AI analysis |

**Note**: Binance public API requires no authentication.

---

## Available Scripts

```bash
# Development
npm run dev          # Start Vite dev server
npx convex dev       # Start Convex backend with hot reload

# Type Checking
npm run typecheck    # Check TypeScript for frontend and backend

# Build
npm run build        # Build for production

# Linting
npm run lint         # Run ESLint

# Preview
npm run preview      # Preview production build locally
```

---

## API Reference

### Convex Functions

| Function | Type | Description |
|----------|------|-------------|
| `wallet.getBalance` | Query | Get current USDT balance |
| `wallet.deposit` | Mutation | Add USDT to wallet |
| `wallet.withdraw` | Mutation | Remove USDT from wallet |
| `assets.list` | Query | Get all portfolio assets |
| `trading.buy` | Action | Buy crypto at market price |
| `trading.sell` | Action | Sell crypto at market price |
| `transactions.listRecent` | Query | Get recent transactions |
| `notifications.list` | Query | Get all notifications |
| `notifications.markAsRead` | Mutation | Mark notification as read |
| `alerts.triggerCheck` | Action | Manually trigger price alert check |

### External APIs

| API | Endpoint | Usage |
|-----|----------|-------|
| Binance | `data-api.binance.vision/api/v3/ticker/price` | Real-time prices |
| Binance | `data-api.binance.vision/api/v3/ticker/24hr` | 24h price changes |
| OpenRouter | `openrouter.ai/api/v1/chat/completions` | AI analysis |

---

## License

MIT